<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BeautyBucket — Quality Cosmetics. Quick Delivery.</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<header class="site-header">
  <div class="brand">
    <h1>BeautyBucket</h1>
    <small>Quality Cosmetics. Quick Delivery.</small>
  </div>
</header>

<main class="main">
  <aside class="sidebar">
    <h3>Categories</h3>
    <ul id="categoryList" class="category-list"></ul>
    <h4>Filter by pincode</h4>
    <input id="pincodeInput" placeholder="Enter pincode" />
    <div id="pincodeMessage" class="muted"></div>
  </aside>

  <section class="content">
    <div class="controls">
      <input id="searchInput" placeholder="Search products..." />
    </div>

    <div id="productList" class="products grid"></div>
  </section>
</main>

<footer class="site-footer">
  <small>© BeautyBucket</small>
</footer>

<script>
// ========== CONFIG ==========
// Replace with your published Google Sheet CSV export URL for products.
// Example: https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID/export?format=csv&gid=0
const PRODUCTS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQA2pIOTPv2AVnMSWtlKLJeSXQXxTllgHn2gGYcdd_ZbHARLmclz_OXy009Aw9hJqgpc-RXIk_HXkK4/pub?gid=0&single=true&output=csv";

// Optional: list of local pincodes (free delivery). Edit this array or maintain in a separate sheet.
const LOCAL_PINCODES = ["411001","411002","411003"]; // example pincodes
const CITY_NAME = "Pune"; // used in shipping message

// ========== CSV PARSER (simple) ==========
function parseCSV(text){
  const lines = text.trim().split('\\n').map(l=>l.trim());
  if(lines.length===0) return [];
  const headers = lines[0].split(',').map(h=>h.trim().replace(/^\"|\"$/g,''));
  const rows = [];
  for(let i=1;i<lines.length;i++){
    const cols = lines[i].split(',').map(c=>c.trim().replace(/^\"|\"$/g,''));
    const obj = {};
    for(let j=0;j<headers.length;j++){
      obj[headers[j]] = cols[j] || "";
    }
    rows.push(obj);
  }
  return rows;
}

// ========== STATE ==========
let allProducts = [];

// ========== UI HELPERS ==========
function formatPrice(v){ return v===undefined||v===''? '—' : '₹'+parseFloat(v).toFixed(2); }
function calcPercent(a,b){ if(!a||a===''||isNaN(parseFloat(a))) return 0; return (((parseFloat(a)-parseFloat(b))/parseFloat(a))*100).toFixed(2); }

// ========== RENDER ==========
function renderCategories(){
  const cats = Array.from(new Set(allProducts.map(p=>p.Category||"Uncategorized")));
  const ul = document.getElementById('categoryList');
  ul.innerHTML = '';
  const liAll = document.createElement('li');
  liAll.textContent = 'All Products';
  liAll.className = 'cat-item active';
  liAll.onclick = ()=>{ document.querySelectorAll('.cat-item').forEach(e=>e.classList.remove('active')); liAll.classList.add('active'); renderProducts(allProducts); };
  ul.appendChild(liAll);
  cats.forEach(c=>{
    const li = document.createElement('li');
    li.textContent = c;
    li.className = 'cat-item';
    li.onclick = async ()=>{ document.querySelectorAll('.cat-item').forEach(e=>e.classList.remove('active')); li.classList.add('active'); renderProducts(allProducts.filter(p=> (p.Category||'').toLowerCase()===c.toLowerCase())); };
    ul.appendChild(li);
  });
}

function renderProducts(list){
  const container = document.getElementById('productList');
  container.innerHTML = '';
  if(!list || list.length===0){
    container.innerHTML = '<div class="empty">No products found</div>';
    return;
  }
  list.forEach(p=>{
    const mrp = parseFloat(p.MRP||0);
    const sp1 = parseFloat(p.SellingPrice1pc||0);
    const sp5 = parseFloat(p.SellingPrice5pc||0);
    const discount1 = calcPercent(mrp, sp1);
    const discount5 = calcPercent(mrp, sp5);
    const stock = parseInt(p.Stock||0);

    const card = document.createElement('div');
    card.className = 'product-card';
    card.innerHTML = `
      <div class="img-wrap"><img src="${p.ImageURL||'images/placeholder.png'}" alt="${p.ProductName||''}" onerror="this.src='images/placeholder.png'"></div>
      <div class="p-body">
        <h4 class="p-title">${p.ProductName||''}</h4>
        <div class="p-cat">${p.Category||''}</div>
        <div class="p-details">${p.Details||''}</div>
        <div class="prices">
          <div class="mrp"><strike>${formatPrice(p.MRP)}</strike></div>
          <div class="sp"> <span class="price">${formatPrice(p.SellingPrice1pc)}</span> <span class="badge">${discount1}% off</span></div>
          <div class="sp-small">5pcs: <span class="price">${formatPrice(p.SellingPrice5pc)}</span> <span class="badge-small">${discount5}% off</span></div>
        </div>
        <div class="stock">${stock>0? 'In stock':'<span class="out">Out of stock</span>'}</div>
        <div class="actions">
          <button class="btn" onclick="buyWhatsapp('${encodeURIComponent(p.ProductName||'')}', '${p.SellingPrice1pc||''}')">Buy via WhatsApp</button>
        </div>
      </div>
    `;
    container.appendChild(card);
  });
}

// ========== BUY VIA WHATSAPP ==========
function buyWhatsapp(productEncoded, sellingPrice){
  const product = decodeURIComponent(productEncoded);
  const pincode = document.getElementById('pincodeInput').value.trim();
  let deliveryMsg = '';
  if(pincode){
    if(LOCAL_PINCODES.includes(pincode)){
      deliveryMsg = 'Free delivery.';
    } else if(pincode.startsWith('411')){ // example: Pune pincodes start with 411
      deliveryMsg = 'Porter service charges applicable.';
    } else {
      deliveryMsg = 'Delivery charges applicable.';
    }
  } else {
    deliveryMsg = 'Please provide pincode for delivery info.';
  }
  const msg = `Hi, I want to buy *${product}* (Price: ₹${sellingPrice}).\\nPincode: ${pincode || '-'}\\n${deliveryMsg}\\nName: \\nAddress: `;
  const waUrl = `https://wa.me/?text=${encodeURIComponent(msg)}`;
  window.open(waUrl, '_blank');
}

// ========== LOAD PRODUCTS ==========
async function loadProducts(){
  try{
    if(!PRODUCTS_CSV_URL || PRODUCTS_CSV_URL.startsWith('REPLACE')){
      document.getElementById('productList').innerHTML = '<div class="empty">No products CSV configured. Please set PRODUCTS_CSV_URL in the script.</div>';
      return;
    }
    const res = await fetch(PRODUCTS_CSV_URL);
    const text = await res.text();
    const rows = parseCSV(text);
    // Map headers fallback names to friendly keys
    allProducts = rows.map(r=>({
      ProductName: r['ProductName']||r['Name']||r['product_name']||'',
      Category: r['Category']||r['category']||'',
      Details: r['Details']||r['details']||'',
      MRP: r['MRP']||r['mrp']||'',
      SellingPrice1pc: r['SellingPrice1pc']||r['selling_price_1pc']||'',
      SellingPrice5pc: r['SellingPrice5pc']||r['selling_price_5pc']||'',
      Stock: r['Stock']||r['stock']||'0',
      ImageURL: r['ImageURL']||r['image_url']||r['Image']||'',
    }));
    renderCategories();
    renderProducts(allProducts);
  }catch(err){
    console.error(err);
    document.getElementById('productList').innerHTML = '<div class="empty">Failed to load products. Check CSV URL and make sure the sheet is published to web.</div>';
  }
}

// ========== SEARCH ==========
document.getElementById('searchInput').addEventListener('input', ()=>{
  const q = document.getElementById('searchInput').value.trim().toLowerCase();
  const filtered = allProducts.filter(p=> (p.ProductName||'').toLowerCase().includes(q) || (p.Details||'').toLowerCase().includes(q));
  renderProducts(filtered);
});

// pincode message
document.getElementById('pincodeInput').addEventListener('input', ()=>{
  const pin = document.getElementById('pincodeInput').value.trim();
  const msgEl = document.getElementById('pincodeMessage');
  if(!pin){ msgEl.textContent = ''; return; }
  if(LOCAL_PINCODES.includes(pin)) msgEl.textContent = 'Free delivery for this pincode.';
  else if(pin.startsWith('411')) msgEl.textContent = 'Porter service charges for Pune.';
  else msgEl.textContent = 'Delivery charges applicable for this pincode.';
});

// Initial load
loadProducts();
</script>
</body>
</html>
