<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BeautyBucket â€” Shop Cosmetics</title>
  <style>
    /* ---------- Base ---------- */
    :root{
      --bg:#f6f6f8; --card:#fff; --text:#111; --muted:#666;
      --accent1:#ff5aa8; --accent2:#ff7ab0; --success:#25D366;
      --glass: rgba(255,255,255,0.6);
    }
    [data-theme="dark"]{
      --bg:#0b0d10; --card:#0f1114; --text:#e6e7ea; --muted:#9aa0a6;
      --glass: rgba(255,255,255,0.03);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
    a,button{font-family:inherit;cursor:pointer}
    .container{max-width:1100px;margin:0 auto;padding:16px}

    /* ---------- Header + Controls ---------- */
    .site-header{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;padding:16px;border-radius:10px}
    .site-header .row{display:flex;align-items:center;gap:12px;justify-content:space-between}
    .brand{font-weight:700;font-size:20px}
    .sub{font-size:13px;opacity:0.95;margin-top:4px}
    .controls{display:flex;gap:8px;align-items:center}
    .icon-btn{background:var(--glass);border-radius:10px;padding:8px 10px;border:0;color:var(--text)}
    .dark-toggle{padding:8px;border-radius:10px;background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.12)}

    /* ---------- Hero ---------- */
    .hero{margin:16px 0 8px;position:relative;border-radius:12px;overflow:hidden;height:220px;box-shadow:0 12px 40px rgba(16,24,40,0.06)}
    .slide{position:absolute;inset:0;display:flex;align-items:center;padding:28px;transition:opacity .6s ease,transform .45s ease;opacity:0;transform:translateY(6px)}
    .slide.show{opacity:1;transform:none}
    .slide .txt h2{font-size:26px;margin-bottom:6px}
    .slide .txt p{color:var(--muted)}
    .hero .nav{position:absolute;top:50%;left:12px;right:12px;display:flex;justify-content:space-between;transform:translateY(-50%);pointer-events:none}
    .hero .arrow{pointer-events:auto;background:#fff;border-radius:999px;padding:8px 10px;box-shadow:0 8px 22px rgba(16,24,40,0.08)}

    /* ---------- Top bar search/pincode ---------- */
    .top-bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:8px 0 12px}
    #searchInput{flex:1 1 220px;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:#fff}
    #pincodeInput{width:130px;padding:8px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:#fff}
    #pincodeMessage{width:100%;font-size:13px;color:var(--muted);margin-top:6px}

    /* ---------- Categories buttons ---------- */
    .filters-row{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    .cat-btn{padding:8px 12px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);background:transparent;color:var(--text);cursor:pointer;box-shadow:0 6px 20px rgba(16,24,40,0.03)}
    .cat-btn.active{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;transform:translateY(-3px);box-shadow:0 18px 40px rgba(255,90,168,0.12)}

    /* ---------- Products grid ---------- */
    .products{display:grid;grid-template-columns:1fr;gap:18px;margin-bottom:40px}
    @media(min-width:800px){.products{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:1200px){.products{grid-template-columns:repeat(3,1fr)}}

    .product-card{background:var(--card);border-radius:14px;padding:12px;border:1px solid rgba(16,24,40,0.04);display:flex;flex-direction:column;min-height:260px;box-shadow:0 8px 28px rgba(16,24,40,0.04);transition:transform .18s,box-shadow .18s}
    .product-card:hover{transform:translateY(-6px);box-shadow:0 24px 60px rgba(16,24,40,0.08)}
    .imgwrap{height:160px;border-radius:10px;background:linear-gradient(180deg,#fff,#fcfcfd);display:flex;align-items:center;justify-content:center;overflow:hidden}
    .imgwrap img{max-width:100%;max-height:100%;object-fit:contain;display:block}

    .p-body{padding:12px 6px 6px;display:flex;flex-direction:column;gap:8px;flex:1}
    .p-title{font-weight:600;font-size:16px;display:flex;align-items:center;gap:8px}
    .p-cat{color:var(--muted);font-size:13px}
    .p-details{color:var(--muted);font-size:13px;min-height:36px}
    .prices{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:auto}
    .mrp{color:#9aa0a6;text-decoration:line-through;font-size:13px}
    .sp{font-weight:700;font-size:16px}
    .discount{color:#d10000;font-size:13px}

    .card-actions{display:flex;gap:8px;align-items:center;margin-top:10px}
    .btn-buy{background:var(--success);color:#fff;padding:8px 12px;border-radius:10px;border:0;font-weight:700}
    .btn-details{padding:8px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:transparent}

    .out-of-stock-overlay{position:absolute;left:12px;top:12px;background:rgba(255,0,0,0.9);color:#fff;padding:6px 8px;border-radius:8px;font-weight:700}

    .heart{margin-left:auto;font-size:18px;color:#bbb;cursor:pointer}
    .heart.faved{color:#e91e63;transform:scale(1.02)}

    /* spinner + error */
    .spinner-wrap{display:flex;align-items:center;justify-content:center;padding:30px}
    .spinner{width:44px;height:44px;border-radius:50%;border:5px solid rgba(0,0,0,0.07);border-top-color:var(--accent1);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    #errorMsg{color:#c00;padding:20px}

    /* modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1200}
    .modal.show{display:flex}
    .modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,0.6)}
    .modal-card{position:relative;background:var(--card);width:92%;max-width:920px;border-radius:12px;padding:18px;z-index:1201;max-height:90vh;overflow:auto}
    .modal-gallery{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .modal-gallery img{width:180px;height:180px;object-fit:contain;border-radius:8px}

    .sentinel{height:1px}
    .muted{color:var(--muted);font-size:13px}
  </style>
</head>
<body>

  <header class="site-header">
    <div class="container">
      <div class="row">
        <div>
          <div class="brand">BeautyBucket</div>
          <div class="sub">Quality Cosmetics. Quick Delivery.</div>
        </div>
        <div class="controls">
          <button id="themeToggle" class="dark-toggle" title="Toggle dark mode">ðŸŒ“</button>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- HERO -->
    <div class="hero" id="hero">
      <div class="slide show" data-index="0">
        <div class="txt">
          <h2>Fresh arrivals â€” curated just for you</h2>
          <p>Discover the latest cosmetics handpicked for quality, performance and style. Free delivery on select pincodes.</p>
        </div>
      </div>
      <div class="slide" data-index="1">
        <div class="txt">
          <h2>Limited time offer: Up to 20% off</h2>
          <p>Special bundle deals on our best sellers. Tap a product and buy directly via WhatsApp.</p>
        </div>
      </div>
      <div class="slide" data-index="2">
        <div class="txt">
          <h2>Clean, cruelty-free formulas</h2>
          <p>We only list responsibly made products â€” quality and safety first.</p>
        </div>
      </div>

      <div class="nav">
        <button id="prevSlide" class="arrow">â€¹</button>
        <button id="nextSlide" class="arrow">â€º</button>
      </div>
    </div>

    <!-- Top bar -->
    <div class="top-bar">
      <div style="flex:1;display:flex;gap:8px;align-items:center">
        <input id="searchInput" placeholder="Search products..." aria-label="Search products">
        <input id="pincodeInput" placeholder="Pincode" aria-label="Pincode">
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div id="pincodeMessage" class="muted">Enter the Pincode to check delivery options</div>
      </div>
    </div>

    <!-- Category buttons -->
    <div class="filters-row" id="categoryFilters"></div>

    <!-- products + spinner + error -->
    <div id="productList" class="products" aria-live="polite"></div>
    <div id="spinner" class="spinner-wrap" style="display:none"><div class="spinner"></div></div>
    <div id="errorMsg" style="display:none"></div>
    <div class="sentinel" id="sentinel"></div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-backdrop" onclick="closeModal()"></div>
    <div class="modal-card" role="dialog" aria-modal="true">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 id="modalTitle" style="margin:0"></h3>
        <button onclick="closeModal()" style="background:transparent;border:0;font-size:20px;cursor:pointer">âœ•</button>
      </div>
      <div id="modalContent"></div>
    </div>
  </div>

<script>
/* ==================== Configuration ==================== */
// Replace this with your published CSV URL
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQA2pIOTPv2AVnMSWtlKLJeSXQXxTllgHn2gGYcdd_ZbHARLmclz_OXy009Aw9hJqgpc-RXIk_HXkK4/pub?gid=1550466309&single=true&output=csv";

// placeholder image (high-quality cosmetic)
const PLACEHOLDER = "https://images.unsplash.com/photo-1522335789203-aabd1fc54bc9?w=900&q=80&auto=format&fit=crop";

/* ==================== State ==================== */
let allProducts = [];   // raw products from CSV
let visible = [];       // filtered + sorted
let filters = { categories: new Set(), sort: 'none', search: '' };
const BATCH = 12;
let renderedCount = 0;
let loading = false;

/* ==================== Utilities ==================== */
function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }
function escapeAttr(s){ if(!s) return ''; return String(s).replaceAll('"','%22').replaceAll("'",'%27'); }

function parseCSV(text){
  text = text.replace(/^\uFEFF/,'').trim();
  const rows=[]; let cur=['']; let col=0; let inQuotes=false;
  for(let i=0;i<text.length;i++){
    const ch=text[i], nxt=text[i+1];
    if(ch=='"'){
      if(inQuotes && nxt=='"'){ cur[col]+='"'; i++; continue; }
      inQuotes=!inQuotes; continue;
    }
    if(!inQuotes && ch==','){ col++; cur[col]=''; continue; }
    if(!inQuotes && (ch=='\n' || ch=='\r')){
      rows.push(cur); cur=['']; col=0; if(ch=='\r' && nxt=='\n') i++; continue;
    }
    cur[col]+=ch;
  }
  if(cur.length>1 || cur[0].trim()!=='') rows.push(cur);
  const headers = rows.shift().map(h=>h.trim());
  return rows.map(r=>{
    const obj={};
    for(let i=0;i<headers.length;i++) obj[headers[i]] = (r[i]||'').trim();
    return obj;
  });
}

// parse ImageURL field (comma separated) into array
function parseImagesField(field){
  if(!field) return [];
  // split on comma but ignore commas inside quotes already handled by CSV parsing
  return field.split(',').map(s=>s.trim()).filter(Boolean);
}

/* ==================== CSV Load ==================== */
async function loadProducts(){
  loading = true;
  document.getElementById('spinner').style.display='flex';
  document.getElementById('errorMsg').style.display='none';
  try{
    const res = await fetch(CSV_URL, {cache:'no-cache'});
    if(!res.ok) throw new Error('CSV fetch failed: '+res.status);
    const txt = await res.text();
    const parsed = parseCSV(txt);

    // normalize products and add Images array + stable id
    allProducts = parsed.map((p,idx)=> {
      const id = ((p.ProductName||'') + '||' + (p.Category||'') + '||' + idx).trim();
      return Object.assign({}, p, {
        Images: parseImagesField(p.ImageURL || ''),
        __id: id
      });
    });

    // init UI
    initFilters();
    applyFiltersAndReset();
  }catch(err){
    console.error('CSV load error', err);
    document.getElementById('errorMsg').textContent = 'Failed to load products. ' + (err.message || '');
    document.getElementById('errorMsg').style.display = 'block';
  }finally{
    loading = false;
    document.getElementById('spinner').style.display='none';
  }
}

/* ==================== Filters ==================== */
function initFilters(){
  const cats = Array.from(new Set(allProducts.map(p => (p.Category||'').trim()).filter(Boolean)));
  const container = document.getElementById('categoryFilters');
  container.innerHTML = '';
  cats.forEach(c=>{
    const btn = document.createElement('button');
    btn.className = 'cat-btn';
    btn.textContent = c;
    btn.dataset.value = c;
    btn.addEventListener('click', (e) => {
      // Shift+click clears all
      if(e.shiftKey){
        filters.categories.clear();
        document.querySelectorAll('.cat-btn').forEach(x => x.classList.remove('active'));
        applyFiltersAndReset();
        return;
      }
      if(filters.categories.has(c)) { filters.categories.delete(c); btn.classList.remove('active'); }
      else { filters.categories.add(c); btn.classList.add('active'); }
      applyFiltersAndReset();
    });
    container.appendChild(btn);
  });

  // search input
  const search = document.getElementById('searchInput');
  search.removeEventListener?.('input', onSearchInput);
  search.addEventListener('input', onSearchInput);

  function onSearchInput(e){
    filters.search = e.target.value.trim().toLowerCase();
    applyFiltersAndReset();
  }
}

/* ==================== Apply filters + sorting ==================== */
function applyFiltersAndReset(){
  visible = allProducts.filter(p=>{
    if(filters.categories.size > 0 && !filters.categories.has((p.Category||'').trim())) return false;
    if(filters.search){
      const hay = ((p.ProductName||'') + ' ' + (p.Details||'')).toLowerCase();
      if(!hay.includes(filters.search)) return false;
    }
    // ensure product has at least a SellingPrice1pc > 0 per your original filter
    const sp1 = parseFloat(p.SellingPrice1pc) || 0;
    if(sp1 <= 0) return false;
    return true;
  });

  // sort
  if(filters.sort === 'price-asc' || filters.sort === 'price-desc'){
    visible.sort((a,b)=>{
      const pa = parseFloat(a.SellingPrice1pc) || 0;
      const pb = parseFloat(b.SellingPrice1pc) || 0;
      return filters.sort === 'price-asc' ? pa - pb : pb - pa;
    });
  } else if(filters.sort === 'discount-desc'){
    visible.sort((a,b)=>{
      const da = parseFloat(a.Discount1pcPercent) || 0;
      const db = parseFloat(b.Discount1pcPercent) || 0;
      return db - da;
    });
  }

  // reset rendering and render first batch
  renderedCount = 0;
  const listEl = document.getElementById('productList');
  listEl.innerHTML = '';
  renderNextBatch();
}

/* ==================== Rendering (batch) ==================== */
function renderNextBatch(){
  if(loading) return;
  const listEl = document.getElementById('productList');
  const frag = document.createDocumentFragment();
  const batch = visible.slice(renderedCount, renderedCount + BATCH);
  if(batch.length === 0){
    if(renderedCount === 0){
      listEl.innerHTML = '<div style="padding:20px;color:var(--muted)">No products found</div>';
    }
    return;
  }

  batch.forEach(p => {
    const name = (p.ProductName||'').trim();
    if(!name) return;
    const imgs = p.Images && p.Images.length ? p.Images : [PLACEHOLDER];
    const imgUrl = imgs[0] || PLACEHOLDER;
    const mrp = p.MRP ? 'â‚¹' + (parseFloat(p.MRP).toFixed(2)) : '';
    const sp1 = p.SellingPrice1pc ? 'â‚¹' + (parseFloat(p.SellingPrice1pc).toFixed(2)) : '';
    const d1 = p.Discount1pcPercent ? (p.Discount1pcPercent + '% off') : '';
    const inStock = p.Stock && parseInt(p.Stock) > 0;

    const card = document.createElement('article');
    card.className = 'product-card';
    card.innerHTML = `
      ${!inStock ? `<div class="out-of-stock-overlay">Out of Stock</div>` : ''}
      <div class="imgwrap">
        <img loading="lazy" src="${escapeAttr(imgUrl)}" alt="${escapeAttr(name)}" onerror="this.onerror=null;this.src='${PLACEHOLDER}'" />
      </div>
      <div class="p-body">
        <div class="p-title">
          <span>${escapeHtml(name)}</span>
          <span class="heart" data-id="${escapeAttr(p.__id)}" title="Add to wishlist">â™¡</span>
        </div>
        <div class="p-cat">${escapeHtml(p.Category || '')}</div>
        <div class="p-details">${escapeHtml(p.Details || '')}</div>
        <div class="prices">
          ${ mrp ? `<div class="mrp">${mrp}</div>` : '' }
          ${ sp1 ? `<div class="sp">${sp1}</div>` : '' }
          ${ d1 ? `<div class="discount">${d1}</div>` : '' }
        </div>
        <div class="card-actions">
          <button class="btn-buy">Buy via WhatsApp</button>
          <button class="btn-details">Details</button>
        </div>
      </div>
    `;

    // hooks: buy, details, wishlist
    card.querySelector('.btn-buy').addEventListener('click', ()=> buyWhatsApp(name));
    card.querySelector('.btn-details').addEventListener('click', ()=> openModal(p));
    const heart = card.querySelector('.heart');
    heart.addEventListener('click', ()=> toggleWishlistById(p.__id, heart));
    if(isWishlistedId(p.__id)) heart.classList.add('faved');

    frag.appendChild(card);
  });

  listEl.appendChild(frag);
  renderedCount += batch.length;
}

/* ==================== Infinite scroll sentinel ==================== */
const sentinel = document.getElementById('sentinel');
const io = new IntersectionObserver((entries)=>{
  if(entries[0].isIntersecting) renderNextBatch();
},{rootMargin:'400px'});
io.observe(sentinel);

/* ==================== Wishlist (by stable id) ==================== */
function wishlistKey(){ return 'bb_wishlist_v2'; }
function getWishlist(){ try{ return JSON.parse(localStorage.getItem(wishlistKey())||'[]'); }catch(e){return []} }
function isWishlistedId(id){ return getWishlist().includes(id); }
function toggleWishlistById(id, el){
  let list = getWishlist();
  if(list.includes(id)){ list = list.filter(x=>x!==id); el.classList.remove('faved'); }
  else { list.push(id); el.classList.add('faved'); }
  localStorage.setItem(wishlistKey(), JSON.stringify(list));
}

/* ==================== Modal (multi-image support) ==================== */
function openModal(p){
  const modal = document.getElementById('modal');
  const content = document.getElementById('modalContent');
  const title = document.getElementById('modalTitle');
  title.textContent = p.ProductName || '';
  const imgs = (p.Images && p.Images.length) ? p.Images : [PLACEHOLDER];
  content.innerHTML = `
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:220px">
        <img src="${escapeAttr(imgs[0])}" style="width:100%;height:auto;max-height:360px;object-fit:contain;border-radius:10px" onerror="this.onerror=null;this.src='${PLACEHOLDER}'" loading="lazy">
      </div>
      <div style="flex:1;min-width:220px">
        <div class="modal-gallery">
          ${imgs.map(src => `<img loading="lazy" src="${escapeAttr(src)}" onerror="this.onerror=null;this.src='${PLACEHOLDER}'">`).join('')}
        </div>
        <p style="margin-top:12px"><strong>Category:</strong> ${escapeHtml(p.Category || '')}</p>
        <p><strong>Details:</strong> ${escapeHtml(p.Details || '')}</p>
        <p style="margin-top:6px"><strong>Price:</strong> ${p.SellingPrice1pc ? 'â‚¹'+parseFloat(p.SellingPrice1pc).toFixed(2) : 'â€”'}</p>
        <div style="margin-top:10px"><button class="btn-buy">Buy via WhatsApp</button></div>
      </div>
    </div>
  `;
  content.querySelector('.btn-buy').addEventListener('click', ()=> buyWhatsApp(p.ProductName || ''));
  modal.classList.add('show'); modal.setAttribute('aria-hidden','false');
}
function closeModal(){ const modal=document.getElementById('modal'); modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); }

/* ==================== Buy via WhatsApp ==================== */
function buyWhatsApp(product){
  const pname = (product||'').trim();
  const pincode = (document.getElementById('pincodeInput')||{value:''}).value.trim();
  const msg = `Hi, I want to buy *${pname}*.\nPincode: ${pincode || '-'}\nName:\nAddress:`;
  window.open(`https://wa.me/918149520594?text=${encodeURIComponent(msg)}`, '_blank');
}

/* ==================== Theme (dark mode) ==================== */
const themeToggle = document.getElementById('themeToggle');
function applySavedTheme(){
  const t = localStorage.getItem('bb_theme') || 'light';
  if(t === 'dark') document.documentElement.setAttribute('data-theme','dark');
  else document.documentElement.removeAttribute('data-theme');
  themeToggle.textContent = t === 'dark' ? 'ðŸŒ™' : 'â˜€ï¸';
}
themeToggle.addEventListener('click', ()=>{
  const cur = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
  const next = cur === 'dark' ? 'light' : 'dark';
  if(next === 'dark') document.documentElement.setAttribute('data-theme','dark');
  else document.documentElement.removeAttribute('data-theme');
  localStorage.setItem('bb_theme', next);
  themeToggle.textContent = next === 'dark' ? 'ðŸŒ™' : 'â˜€ï¸';
});
applySavedTheme();

/* ==================== Hero slider ==================== */
let heroIndex = 0;
const slides = Array.from(document.querySelectorAll('.hero .slide'));
function showSlide(i){
  slides.forEach(s => s.classList.remove('show'));
  const idx = ((i % slides.length) + slides.length) % slides.length;
  slides[idx].classList.add('show');
  heroIndex = idx;
}
document.getElementById('prevSlide').addEventListener('click', ()=> { showSlide(heroIndex-1); });
document.getElementById('nextSlide').addEventListener('click', ()=> { showSlide(heroIndex+1); });
let heroTimer = setInterval(()=> showSlide(heroIndex+1), 5000);

/* Pause on hover */
const heroEl = document.getElementById('hero');
heroEl.addEventListener('mouseenter', ()=> clearInterval(heroTimer));
heroEl.addEventListener('mouseleave', ()=> heroTimer = setInterval(()=> showSlide(heroIndex+1), 5000));

/* ==================== Sorting control (optional UI) ==================== */
// small keyboard shortcuts: press "p" for price-asc, "d" for discount-desc, "n" for none
document.addEventListener('keydown', (e)=>{
  if(e.key === 'p'){ filters.sort = 'price-asc'; applyFiltersAndReset(); }
  if(e.key === 'P'){ filters.sort = 'price-desc'; applyFiltersAndReset(); }
  if(e.key === 'd'){ filters.sort = 'discount-desc'; applyFiltersAndReset(); }
  if(e.key === 'n'){ filters.sort = 'none'; applyFiltersAndReset(); }
});

/* ==================== Initialize ==================== */
document.getElementById('modal').addEventListener('click', (ev)=>{
  if(ev.target.id === 'modal' || ev.target.classList.contains('modal-backdrop')) closeModal();
});

// initialize load
loadProducts();
</script>
</body>
</html>
